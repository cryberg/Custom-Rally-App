<!DOCTYPE html>
<html>
<head>
    <title>CustomApp</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"exportBtn"},{xtype:"container",itemId:"gridContainer"}],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading data..."}),this._myMask.show(),Ext.create("Rally.data.wsapi.Store",{model:"UserStory",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","Name","TestCases","Feature"],limit:1/0,listeners:{load:this._onDataLoaded,scope:this}})},_onDataLoaded:function(store,data){var stories=[],pendingTestCases=data.length;_.each(data,function(story){var s={Feature:story.get("Feature"),FormattedID:story.get("FormattedID"),Name:story.get("Name"),_ref:story.get("_ref"),TestCaseCount:story.get("TestCases").Count,TestCases:[]},testcases=story.getCollection("TestCases",{fetch:["FormattedID"]});testcases.load({callback:function(records,operation,success){_.each(records,function(testcase){s.TestCases.push({_ref:testcase.get("_ref"),FormattedID:testcase.get("FormattedID"),Name:testcase.get("Name")})},this),--pendingTestCases,0===pendingTestCases&&this._makeGrid(stories)},scope:this}),stories.push(s)},this)},_makeGrid:function(stories){this._myMask.hide();var store=Ext.create("Rally.data.custom.Store",{data:stories});this._stories=stories,this._grid=Ext.create("Rally.ui.grid.Grid",{itemId:"storiesGrid",store:store,columnCfgs:[{text:"Feature",dataIndex:"Feature",renderer:function(value){var html=[];return value?'<a href="'+Rally.nav.Manager.getDetailUrl(value)+'">'+value.FormattedID+"</a>":void 0}},{text:"Formatted ID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name"},{text:"Test Case Count",dataIndex:"TestCaseCount",align:"center"},{text:"Test Cases",dataIndex:"TestCases",sortable:!1,renderer:function(value){var html=[];return Ext.Array.each(value,function(testcase){html.push('<a href="'+Rally.nav.Manager.getDetailUrl(testcase)+'">'+testcase.FormattedID+"</a>")}),html.join("</br>")}}]}),this.down("#gridContainer").add(this._grid),this.down("#exportBtn").add({xtype:"rallybutton",text:"Export to CSV",handler:this._onClickExport,scope:this})},_onClickExport:function(){var data=this._getCSV();window.location="data:text/csv;charset=utf8,"+encodeURIComponent(data)},_getCSV:function(){var cols=this._grid.columns,store=this._grid.store,data="";return _.each(cols,function(col,index){data+=this._getFieldTextAndEscape(col.text)+","},this),console.trace("getting CSV"),data+="\r\n",_.each(this._stories,function(record){var featureData=record.Feature;_.each(cols,function(col,index){var text="",fieldName=col.dataIndex;if("Feature"===fieldName&&featureData)text=featureData.FormattedID;else if("TestCaseCount"===fieldName)text=""+record[fieldName],0!==record[fieldName]&&(console.log("testcases!"),console.log(record.TestCases));else if("TestCases"===fieldName){var textArr=[];_.each(record[fieldName],function(testcase,index){textArr.push(testcase.FormattedID)}),text=textArr.join(", ")}else text=record[fieldName];data+=this._getFieldTextAndEscape(text)+","},this),data+="\r\n"},this),data},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getFieldText:function(fieldData){var text;return text=null!==fieldData&&void 0!==fieldData&&fieldData.match?fieldData._refObjectName?fieldData._refObjectName:fieldData:""},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string}});

            Rally.launchApp('CustomApp', {
                name:"CustomApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
