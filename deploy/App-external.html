<!DOCTYPE html>
<html>
<head>
    <title>CustomApp</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){console.log("PI GRID"),Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Feature",fetch:["FormattedID","Name","UserStories","Release","Project"],pageSize:100,autoLoad:!0,listeners:{load:this._onDataLoaded,scope:this}})},_createGrid:function(features){this.add({xtype:"rallygrid",store:Ext.create("Rally.data.custom.Store",{data:features,pageSize:100}),columnCfgs:[{text:"Formatted ID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name"},{text:"Release",dataIndex:"Release"},{text:"Project",dataIndex:"Project"},{text:"Story Count",dataIndex:"StoryCount"},{text:"User Stories",dataIndex:"UserStories",renderer:function(value){var html=[];return Ext.Array.each(value,function(userstory){html.push('<a href="'+Rally.nav.Manager.getDetailUrl(userstory)+'">'+userstory.FormattedID+" - "+userstory.Name+"</a>")}),html.join("<br>")}}]})},_onDataLoaded:function(store,data){var features=[],pendingstories=data.length;Ext.Array.each(data,function(feature){console.log(feature);var release=feature.get("Release"),f={FormattedID:feature.get("FormattedID"),Name:feature.get("Name"),Release:release&&release.Name||"None",Project:feature.get("Project")._refObjectName,_ref:feature.get("_ref"),StoryCount:feature.get("UserStories").Count,UserStories:[]},stories=feature.getCollection("UserStories");stories.load({fetch:["FormattedID","Name"],callback:function(records,operation,success){Ext.Array.each(records,function(story){var number=story.get("DirectChildrenCount");0===number&&f.UserStories.push({_ref:story.get("_ref"),FormattedID:story.get("FormattedID"),Name:story.get("Name")})},this),--pendingstories,0===pendingstories&&this._createGrid(features)},scope:this}),features.push(f)},this)}});

            Rally.launchApp('CustomApp', {
                name:"CustomApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
